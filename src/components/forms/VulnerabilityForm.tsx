'use client';

import { useState, useEffect } from 'react';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Checkbox } from '@/components/ui/checkbox';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Heart, Users, Shield, AlertCircle, Plus, Trash2, UserX } from 'lucide-react';
import { SurveyFormData, VulnerabilityNeeds } from '@/lib/types';

interface VulnerabilityFormProps {
  data: SurveyFormData;
  onUpdate: (data: Partial<SurveyFormData>) => void;
}

export function VulnerabilityForm({ data, onUpdate }: VulnerabilityFormProps) {
  const [vulnerabilityNeeds, setVulnerabilityNeeds] = useState<VulnerabilityNeeds>({
    femaleHeadedHouseholds: data.vulnerabilityNeeds?.femaleHeadedHouseholds || false,
    orphansPresent: data.vulnerabilityNeeds?.orphansPresent || false,
    elderlyWithoutSupport: data.vulnerabilityNeeds?.elderlyWithoutSupport || false,
    personsWithDisabilities: data.vulnerabilityNeeds?.personsWithDisabilities || [],
    dependentOnSupport: data.vulnerabilityNeeds?.dependentOnSupport || false,
  });

  const [newDisability, setNewDisability] = useState('');

  useEffect(() => {
    onUpdate({ vulnerabilityNeeds });
  }, [vulnerabilityNeeds, onUpdate]);

  const updateField = (field: keyof VulnerabilityNeeds, value: any) => {
    setVulnerabilityNeeds(prev => ({ ...prev, [field]: value }));
  };

  const addDisability = () => {
    if (newDisability.trim()) {
      setVulnerabilityNeeds(prev => ({
        ...prev,
        personsWithDisabilities: [...prev.personsWithDisabilities, newDisability.trim()]
      }));
      setNewDisability('');
    }
  };

  const removeDisability = (index: number) => {
    setVulnerabilityNeeds(prev => ({
      ...prev,
      personsWithDisabilities: prev.personsWithDisabilities.filter((_, i) => i !== index)
    }));
  };

  const getVulnerabilityCount = () => {
    let count = 0;
    if (vulnerabilityNeeds.femaleHeadedHouseholds) count++;
    if (vulnerabilityNeeds.orphansPresent) count++;
    if (vulnerabilityNeeds.elderlyWithoutSupport) count++;
    if (vulnerabilityNeeds.personsWithDisabilities.length > 0) count++;
    if (vulnerabilityNeeds.dependentOnSupport) count++;
    return count;
  };

  const vulnerabilityLevel = getVulnerabilityCount();
  const isHighVulnerability = vulnerabilityLevel >= 3;
  const isMediumVulnerability = vulnerabilityLevel === 2;

  return (
    <div className="space-y-6">
      {/* Vulnerability Status Overview */}
      <Card>
        <CardContent className="pt-6">
          <div className={`p-4 rounded-lg border-2 ${
            isHighVulnerability ? 'bg-red-50 border-red-200' :
            isMediumVulnerability ? 'bg-yellow-50 border-yellow-200' :
            'bg-green-50 border-green-200'
          }`}>
            <div className="flex items-center justify-between">
              <div>
                <h3 className={`font-semibold ${
                  isHighVulnerability ? 'text-red-900' :
                  isMediumVulnerability ? 'text-yellow-900' :
                  'text-green-900'
                }`}>
                  Household Vulnerability Level: {
                    isHighVulnerability ? 'HIGH' :
                    isMediumVulnerability ? 'MEDIUM' :
                    'LOW'
                  }
                </h3>
                <p className={`text-sm ${
                  isHighVulnerability ? 'text-red-700' :
                  isMediumVulnerability ? 'text-yellow-700' :
                  'text-green-700'
                }`}>
                  {vulnerabilityLevel} vulnerability factor(s) identified
                </p>
              </div>
              <AlertCircle className={`h-8 w-8 ${
                isHighVulnerability ? 'text-red-600' :
                isMediumVulnerability ? 'text-yellow-600' :
                'text-green-600'
              }`} />
            </div>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center space-x-2">
            <UserX className="h-5 w-5" />
            <span>Female-Headed Households</span>
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex items-center space-x-2">
            <Checkbox
              id="female-headed"
              checked={vulnerabilityNeeds.femaleHeadedHouseholds}
              onCheckedChange={(checked) => updateField('femaleHeadedHouseholds', !!checked)}
            />
            <label htmlFor="female-headed" className="text-sm font-medium">
              This household is headed by a female
            </label>
          </div>

          {vulnerabilityNeeds.femaleHeadedHouseholds && (
            <div className="bg-pink-50 p-4 rounded-lg">
              <h4 className="font-medium text-pink-900 mb-3">Female-Headed Household Details</h4>
              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-medium mb-1">Circumstances</label>
                  <Textarea
                    placeholder="Describe circumstances (widowed, divorced, separated, single mother, etc.)"
                    rows={2}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Number of Dependents</label>
                  <Input
                    type="number"
                    min="0"
                    placeholder="Children and other dependents"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Primary Challenges</label>
                  <Textarea
                    placeholder="Main challenges faced as a female-headed household..."
                    rows={2}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Support Needed</label>
                  <Textarea
                    placeholder="What specific support would help this household?"
                    rows={2}
                  />
                </div>
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center space-x-2">
            <Users className="h-5 w-5" />
            <span>Orphans</span>
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex items-center space-x-2">
            <Checkbox
              id="orphans-present"
              checked={vulnerabilityNeeds.orphansPresent}
              onCheckedChange={(checked) => updateField('orphansPresent', !!checked)}
            />
            <label htmlFor="orphans-present" className="text-sm font-medium">
              There are orphaned children in this household
            </label>
          </div>

          {vulnerabilityNeeds.orphansPresent && (
            <div className="bg-blue-50 p-4 rounded-lg">
              <h4 className="font-medium text-blue-900 mb-3">Orphan Details</h4>
              <div className="space-y-3">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-medium mb-1">Number of Orphans</label>
                    <Input
                      type="number"
                      min="0"
                      placeholder="Total orphaned children"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Ages of Orphans</label>
                    <Input placeholder="e.g., 5, 8, 12 years old" />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Circumstances</label>
                  <Textarea
                    placeholder="How did the children become orphaned? When? Current care arrangements?"
                    rows={2}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Care and Support Needs</label>
                  <Textarea
                    placeholder="What care, education, and support do these children need?"
                    rows={2}
                  />
                </div>
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center space-x-2">
            <Heart className="h-5 w-5" />
            <span>Elderly Without Support</span>
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex items-center space-x-2">
            <Checkbox
              id="elderly-without-support"
              checked={vulnerabilityNeeds.elderlyWithoutSupport}
              onCheckedChange={(checked) => updateField('elderlyWithoutSupport', !!checked)}
            />
            <label htmlFor="elderly-without-support" className="text-sm font-medium">
              There are elderly people without adequate support in this household
            </label>
          </div>

          {vulnerabilityNeeds.elderlyWithoutSupport && (
            <div className="bg-orange-50 p-4 rounded-lg">
              <h4 className="font-medium text-orange-900 mb-3">Elderly Support Details</h4>
              <div className="space-y-3">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-medium mb-1">Number of Elderly</label>
                    <Input
                      type="number"
                      min="0"
                      placeholder="Elderly without support"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Ages</label>
                    <Input placeholder="e.g., 65, 72, 85 years old" />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Current Care Situation</label>
                  <Textarea
                    placeholder="Who currently cares for elderly members? What support is available?"
                    rows={2}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Health and Mobility Issues</label>
                  <Textarea
                    placeholder="Any health problems, mobility limitations, or special care needs?"
                    rows={2}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Support Needed</label>
                  <Textarea
                    placeholder="What support services would help care for elderly members?"
                    rows={2}
                  />
                </div>
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center space-x-2">
            <Shield className="h-5 w-5" />
            <span>Persons with Disabilities</span>
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-2">
              Disabilities in Household
            </label>

            <div className="space-y-2">
              {vulnerabilityNeeds.personsWithDisabilities.map((disability, index) => (
                <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded">
                  <span className="text-sm">{disability}</span>
                  <Button
                    onClick={() => removeDisability(index)}
                    variant="ghost"
                    size="sm"
                    className="text-red-600 hover:text-red-700"
                  >
                    <Trash2 className="h-4 w-4" />
                  </Button>
                </div>
              ))}

              {vulnerabilityNeeds.personsWithDisabilities.length === 0 && (
                <p className="text-sm text-gray-500 italic py-2">No disabilities reported</p>
              )}
            </div>

            <div className="flex space-x-2 mt-3">
              <Input
                value={newDisability}
                onChange={(e) => setNewDisability(e.target.value)}
                placeholder="e.g., Physical disability, Vision impairment, Hearing loss, Intellectual disability"
                onKeyPress={(e) => e.key === 'Enter' && addDisability()}
              />
              <Button
                onClick={addDisability}
                disabled={!newDisability.trim()}
                size="sm"
              >
                <Plus className="h-4 w-4 mr-1" />
                Add
              </Button>
            </div>
          </div>

          {vulnerabilityNeeds.personsWithDisabilities.length > 0 && (
            <div className="bg-purple-50 p-4 rounded-lg">
              <h4 className="font-medium text-purple-900 mb-3">Disability Support Details</h4>
              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-medium mb-1">Daily Living Assistance</label>
                  <Textarea
                    placeholder="What assistance do persons with disabilities need for daily activities?"
                    rows={2}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Accessibility Needs</label>
                  <Textarea
                    placeholder="What accessibility features or accommodations are needed?"
                    rows={2}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Medical/Therapy Needs</label>
                  <Textarea
                    placeholder="Any ongoing medical treatment, therapy, or specialized care needed?"
                    rows={2}
                  />
                </div>
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Dependency on Support</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex items-center space-x-2">
            <Checkbox
              id="dependent-on-support"
              checked={vulnerabilityNeeds.dependentOnSupport}
              onCheckedChange={(checked) => updateField('dependentOnSupport', !!checked)}
            />
            <label htmlFor="dependent-on-support" className="text-sm font-medium">
              This household is fully dependent on government/church/NGO support
            </label>
          </div>

          {vulnerabilityNeeds.dependentOnSupport && (
            <div className="bg-red-50 p-4 rounded-lg">
              <h4 className="font-medium text-red-900 mb-3">Support Dependency Details</h4>
              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-medium mb-1">Types of Support Received</label>
                  <Textarea
                    placeholder="What types of support does the household receive? (food aid, cash assistance, housing, medical care, etc.)"
                    rows={2}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Support Providers</label>
                  <Textarea
                    placeholder="Who provides this support? (government agencies, churches, NGOs, family, etc.)"
                    rows={2}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Reasons for Dependency</label>
                  <Textarea
                    placeholder="Why is the household unable to be self-sufficient? What barriers exist?"
                    rows={2}
                  />
                </div>
              </div>
            </div>
          )}

          <div>
            <label className="block text-sm font-medium mb-2">
              Pathway to Self-Sufficiency
            </label>
            <Textarea
              placeholder="What support or opportunities would help this household become more self-sufficient?"
              rows={3}
            />
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Special Needs in Resettlement</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-2">
              Priority Support Needs
            </label>
            <Textarea
              placeholder="What are the most urgent support needs for this household in the resettlement process?"
              rows={3}
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-2">
              Special Accommodations Needed
            </label>
            <Textarea
              placeholder="What special accommodations or considerations are needed in the new settlement?"
              rows={3}
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-2">
              Support Services Required
            </label>
            <Textarea
              placeholder="What ongoing support services would this household need in the new location?"
              rows={3}
            />
          </div>
        </CardContent>
      </Card>

      {/* Summary */}
      <Card>
        <CardContent className="pt-6">
          <div className={`p-4 rounded-lg ${
            isHighVulnerability ? 'bg-red-50' :
            isMediumVulnerability ? 'bg-yellow-50' :
            'bg-green-50'
          }`}>
            <h4 className={`font-medium mb-2 ${
              isHighVulnerability ? 'text-red-900' :
              isMediumVulnerability ? 'text-yellow-900' :
              'text-green-900'
            }`}>
              Vulnerability & Special Needs Summary
            </h4>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <p><strong>Vulnerability Level:</strong> {
                  isHighVulnerability ? 'HIGH' :
                  isMediumVulnerability ? 'MEDIUM' : 'LOW'
                }</p>
                <p><strong>Female-Headed:</strong> {vulnerabilityNeeds.femaleHeadedHouseholds ? 'Yes' : 'No'}</p>
                <p><strong>Orphans Present:</strong> {vulnerabilityNeeds.orphansPresent ? 'Yes' : 'No'}</p>
              </div>
              <div>
                <p><strong>Elderly Support:</strong> {vulnerabilityNeeds.elderlyWithoutSupport ? 'Needed' : 'Adequate'}</p>
                <p><strong>Disabilities:</strong> {vulnerabilityNeeds.personsWithDisabilities.length} reported</p>
                <p><strong>Fully Dependent:</strong> {vulnerabilityNeeds.dependentOnSupport ? 'Yes' : 'No'}</p>
              </div>
            </div>

            {isHighVulnerability && (
              <div className="mt-3 p-3 bg-red-100 rounded border-l-4 border-red-500">
                <p className="text-red-800 font-medium">⚠️ HIGH PRIORITY: This household requires immediate attention and comprehensive support services.</p>
              </div>
            )}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
